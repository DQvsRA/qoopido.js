(function(e,t,n){"use strict";var r="qoopido",i="shrinkimage",s={attribute:"data-"+i,quality:80,debug:!1},o;o=function(o,u,a,f){var l=!1,c={},h=e.location.hostname,p=o("<a />"),d={test:new RegExp('^url(\\x28"{0,1}|)data:image/shrink,(.+?)("{0,1}\\x29|)$',"i"),path:new RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),hostname:new RegExp("^\\w+://([^/]+)","i")},v,m,g="requested."+i,y="queued."+i,b="cached."+i,w="loaded."+i,E="load";return f.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(function(){l=!0}),o.fn[i]=function(e){return e=o.extend({},s,e||{}),this.each(function(){var t=o(this),n=t.attr(e.attribute),r=t.css("background-image");this.tagName==="IMG"&&(l===!0&&e.debug===!1?m.create(e,t,n):t.attr("src",n).removeAttr(e.attribute)),r!=="none"&&d.test.test(r)===!0&&(l===!0&&e.debug===!1?m.create(e,t,r,!0):t.css("background-image","url("+d.path.exec(r)[1]+")"))})},v=function(t,n){return o("<img />").attr(t,n).on(E,function(e){e.stopPropagation()})},m=u.extend({_constructor:function(e,t,n,r){var u=this;u._loader=null,u._settings=o.extend({},s,e||{}),u._target=t.css({visibility:"hidden",opacity:0}),u._background=r||!1,u._result=null,u._url=n||!1,u._parameter={quality:u._getParameter("quality",u._url)||u._settings.quality,source:u._url!==!1?d.path.exec(u._resolveUrl(u._url))[1].split("?")[0]:!1,target:u._getParameter("target",u._url)||!1};if(u._url!==!1){u._parameter.target===!1&&(u._parameter.target=u._parameter.source.replace(/\.png$/i,".q"+u._parameter.quality+".shrunk")),u._target.removeAttr(u._settings.attribute);switch(typeof c[u._parameter.target]){case"object":c[u._parameter.target]._target.one(b,function(e){e.namespace===i&&u._assign(!0)}),u._target.trigger(y,[u._parameter.target]);break;case"string":u._assign(!0);break;default:u._loader=v(e.attribute,n),c[u._parameter.target]=u,u._load(),u._target.trigger(g,[u._parameter.target])}}},_load:function(){var t=this,r=h===d.hostname.exec(t._parameter.target)[1]?!1:!0;o.ajax({url:r===!0?t._parameter.target+".jsonp":t._parameter.target,context:t,data:{source:t._parameter.source,quality:t._parameter.quality},global:!1,cache:!0,crossDomain:r||null,dataType:r===!0?"jsonp":"json",jsonpCallback:r===!0?function(){var t;do t=i+"-"+a.generate();while(e[t]!==n);return t}:null}).fail(function(e,n,r){t._fallback()}).done(function(e,r,i){typeof e!="object"||e.width===n||e.height===n||e.size===n||e.main===n||e.alpha===n?t._fallback():(t._result={original:parseInt(e.size,10),compressed:parseInt(i.getResponseHeader("Content-Length"),10)},t._process(e))})},_fallback:function(){var e=this;c[e._parameter.target]=e._parameter.source,e._assign(!1,!0)},_process:function(e){var n=this;n._loader.one(E,function(){var r=t.createElement("canvas"),i=n._loader.get(0),s;r.style.display="none",r.width=e.width,r.height=e.height,s=r.getContext("2d"),s.clearRect(0,0,e.width,e.height),s.drawImage(i,0,0,e.width,e.height),n._loader.one(E,function(){n._loader.remove(),s.globalCompositeOperation="xor",s.drawImage(i,0,0,e.width,e.height),c[n._parameter.target]=r.toDataURL("image/png"),o(r).remove(),n._assign()}).attr("src",e.alpha)}).attr("src",e.main)},_assign:function(e,t){var n=this;n._background===!1?n._target.one(E,function(){n._target.css({visibility:"",opacity:""}).trigger(w,[n._parameter.target,e||!1,t||!1])}).attr("src",c[n._parameter.target]):n._target.css({"background-image":"url("+c[n._parameter.target]+")"}).trigger(w,[n._parameter.target,e||!1,t||!1]),e!==!0&&n._result!==null&&n._target.trigger(b,[n._parameter.target,n._result.compressed,n._result.original])},_resolveUrl:function(e){return p.attr("href",e).prop("href")},_getParameter:function(e,t){return decodeURIComponent(((new RegExp("[?|&]"+e+"="+"([^&;]+?)(&|#|;|$)")).exec(t)||["",""])[1].replace(/\+/g,"%20"))||null}}),m},typeof define=="function"&&define.amd?define(["jquery","qoopido/base","qoopido/uuid","qoopido/support","qoopido/support/capability/datauri","qoopido/support/element/canvas/todataurl/png"],function(e,t,n,r){return o(e,t,n,r)}):(e[r]=e[r]||{},e[r][i]=o(jQuery,e[r].base,e[r].support))})(window,document);